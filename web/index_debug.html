<!doctype html>
<html lang="fr" style="color-scheme: dark;">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Coach â€” Conversation naturelle</title>
  <style>
    :root{
      --bg:#0b0b0e;--panel:#121217;--muted:#6b7280;--text:#e5e7eb;--accent:#4f46e5;--accent-2:#22d3ee;
      --me:#1f2937;--them:#0d9488;--radius:16px;--radius-sm:12px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:linear-gradient(180deg,#0a0a0d 0%,#0b0b0e 100%);color:var(--text);
      font:16px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui;
      display:flex;align-items:center;justify-content:center;padding:14px;
    }
    .app{
      width:100%;max-width:760px;background:rgba(18,18,23,.8);backdrop-filter: blur(8px);
      border:1px solid #1f2430;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);
      overflow:hidden;display:flex;flex-direction:column;min-height:70vh;
    }
    header{
      padding:14px 16px;border-bottom:1px solid #1f2430;display:flex;gap:10px;align-items:center;flex-wrap:wrap
    }
    header .title{font-weight:700;letter-spacing:.2px}
    header input.api{
      flex:1;min-width:180px;background:#0f0f14;border:1px solid #222739;border-radius:10px;
      color:var(--text);padding:8px 10px;font-size:14px
    }
    header button.small{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));border:0;border-radius:10px;
      color:white;padding:8px 10px;font-weight:600;font-size:14px;cursor:pointer
    }

    .scroll{flex:1;overflow:auto;padding:14px;display:flex;flex-direction:column;gap:12px}
    .bubble{
      max-width:86%;padding:10px 12px;border-radius:14px;position:relative;white-space:pre-wrap;word-wrap:break-word
    }
    .bubble.me{align-self:flex-end;background:var(--me);border-top-right-radius:6px}
    .bubble.ai{align-self:flex-start;background:var(--them);border-top-left-radius:6px}

    .panel{padding:12px;border-top:1px solid #1f2430;background:var(--panel)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid .col{display:flex;gap:8px}
    select,input[type=text],input[type=number]{
      width:100%;background:#0f0f14;border:1px solid #222739;border-radius:12px;color:var(--text);
      padding:10px 12px;font-size:15px
    }
    textarea{
      width:100%;min-height:90px;max-height:40vh;resize:vertical;background:#0f0f14;border:1px solid #222739;
      border-radius:14px;color:var(--text);padding:12px;font-size:15px;margin-top:8px
    }
    .actions{display:flex;gap:8px;margin-top:10px}
    .btn{
      appearance:none;cursor:pointer;border:0;border-radius:14px;padding:12px 16px;font-weight:700
    }
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;flex:1}
    .btn.ghost{background:#0f0f14;border:1px solid #222739;color:var(--text)}
    .muted{color:var(--muted);font-size:12px;margin-top:6px}
    .pulse{animation:pulse 1.1s infinite}
    @keyframes pulse{0%{opacity:.4}50%{opacity:1}100%{opacity:.4}}
    @media (max-width:640px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <header>
  <div class="title">Coach â€¢ Conversation</div>
  <select id="siteSelect"></select>
  <button class="small" id="refreshSites">Sites</button>
    </header>

    <div class="scroll" id="chat">
      <!-- historique affichÃ© ici -->
    </div>

    <div class="panel">
      <div style="margin-bottom:12px">
        <strong>ðŸ’¬ Parlez-moi naturellement !</strong><br>
        <small class="muted">Dites ce que vous voulez faire, et je m'occupe du reste</small>
      </div>
      <textarea id="userInput" placeholder="Ex: 'Analyse le site web example.com', 'Organise mes fichiers Python', 'VÃ©rifie le gateway', 'GÃ©nÃ¨re un rÃ©sumÃ© de ce document'..."></textarea>
      <div class="actions">
        <button class="btn ghost" id="clear">Effacer</button>
        <button class="btn primary" id="send">Envoyer</button>
      </div>
      <div class="muted" id="status"></div>
    </div>
  </div>

  <script>
    // Cache busting - force reload
    const CACHE_BUSTER = '?v=' + Date.now();
    
    const apiEl = { value: 'http://localhost:5057' }; // Fixed API to avoid CORS issues
    const chatEl = document.getElementById('chat');
    const userInputEl = document.getElementById('userInput');
    const sendBtn = document.getElementById('send');
    const clearBtn = document.getElementById('clear');
    const statusEl = document.getElementById('status');
    const siteSelect = document.getElementById('siteSelect');
    const refreshSitesBtn = document.getElementById('refreshSites');

    // Debug logging
    console.log('Coach interface loaded at:', new Date().toISOString());
    console.log('API endpoint:', apiEl.value);

    function addBubble(text, who){
      console.log('Adding bubble:', who, text.substring(0, 50) + '...');
      const b = document.createElement('div');
      b.className = 'bubble ' + who;
      b.textContent = text;
      chatEl.appendChild(b);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    clearBtn.onclick = () => {
      console.log('Clear button clicked');
      chatEl.innerHTML = '';
      userInputEl.value = '';
      statusEl.textContent = '';
    };

    async function converseWithCoach(){
      console.log('converseWithCoach called');
      const api = (apiEl.value || '').trim().replace(/\/+$/,'');
      const query = userInputEl.value.trim();
      console.log('API:', api, 'Query:', query);
      
      if(!api || !query) {
        console.log('Missing API or query');
        return alert("Tape une commande naturelle.");
      }

      // Add user message to chat
      addBubble(query, 'me');
      userInputEl.value = '';

      // Show typing indicator
      statusEl.textContent = 'Le coach rÃ©flÃ©chit...';
      const typing = document.createElement('div');
      typing.className = 'bubble ai pulse';
      typing.textContent = 'â€¦';
      chatEl.appendChild(typing);
      chatEl.scrollTop = chatEl.scrollHeight;

      try{
        console.log('Making fetch request to:', api + '/coach/converse');
        const r = await fetch(api + '/coach/converse', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(query)
        });
        console.log('Fetch response status:', r.status);
        
        if(!r.ok){
          const t = await r.text();
          console.error('Fetch failed:', r.status, t);
          throw new Error(`HTTP ${r.status}: ${t.slice(0,200)}`);
        }
        const data = await r.json();
        console.log('Response data:', data);
        typing.remove();
        statusEl.textContent = '';

        // Display the response
        if(data.error){
          addBubble('Erreur: ' + data.error, 'ai');
        } else if(data.response){
          addBubble(data.response, 'ai');
        } else if(data.analysis){
          addBubble('Analyse: ' + data.analysis, 'ai');
        } else if(data.rephrased){
          addBubble('RephrasÃ©: ' + data.rephrased, 'ai');
        } else if(data.status){
          let result = `Statut: ${data.status}\n\n`;
          if(data.checks){
            for(const [key, value] of Object.entries(data.checks)){
              result += `${key}: ${value}\n`;
            }
          }
          addBubble(result, 'ai');
        } else {
          addBubble(JSON.stringify(data, null, 2), 'ai');
        }
      }catch(err){
        console.error('Error in converseWithCoach:', err);
        typing.remove();
        statusEl.textContent = '';
        addBubble('Erreur: ' + err.message, 'ai');
      }
    }

    sendBtn.onclick = () => {
      console.log('Send button clicked');
      converseWithCoach();
    };

    // Enter to send
    userInputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        console.log('Enter key pressed');
        converseWithCoach();
      }
    });

    // Load sites functionality
    async function loadSites() {
      const api = (apiEl.value || '').trim().replace(/\/+$/,'');
      if (!api) return;
      try {
        console.log('Loading sites from:', api + '/remote/sites');
        const r = await fetch(api + '/remote/sites');
        const data = await r.json();
        console.log('Sites loaded:', data);
        siteSelect.innerHTML = '';
        data.sites.forEach(site => {
          const opt = document.createElement('option');
          opt.value = site.name;
          opt.textContent = site.name;
          siteSelect.appendChild(opt);
        });
      } catch (e) {
        console.error('Error loading sites:', e);
        siteSelect.innerHTML = '<option>Erreur chargement sites</option>';
      }
    }
    refreshSitesBtn.onclick = () => {
      console.log('Refresh sites clicked');
      loadSites();
    };

    // Charger la liste des sites au dÃ©marrage
    window.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing...');
      loadSites();
    });
  </script>
</body>
</html>